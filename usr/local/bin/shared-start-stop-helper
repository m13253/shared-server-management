#!/bin/bash

if [ "$#" != "2" ]
then
    echo "This file is a part of shared-server-management, released under GPL 3.0."
    exit 1
fi
target_username="$(basename "$2")"
if [ "$(whoami)" != "$target_username" ]
then
    exec su "$target_username" -c "bash '$(echo -n "$0" | sed -e "s/'/'\\\\''/g")' '$(echo -n "$1" | sed -e "s/'/'\\\\''/g")' '$(echo -n "$2" | sed -e "s/'/'\\\\''/g")'"
    exit
fi
cd "$2"
source /etc/profile
if [ -f "$2/.bashrc" ]
then
    source "$2/.bashrc"
fi
if [ ! -d "$2/rc.d" ]
then
    exit
fi
case "$1" in
    start)
        find "$2/rc.d" | grep -E '\.start$|\.conf$' | sort | while read line
        do
            echo ":: Starting $line" >&2
            bash "$line" start
        done
        ;;
    stop)
        find "$2/rc.d" | grep -E '\.stop$|\.conf$' | sort -r | while read line
        do
            echo ":: Stopping $line" >&2
            bash "$line" stop
        done
        ;;
esac
